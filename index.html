<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NovaScholar - AI AP Exam Prep</title>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text: #0f172a;
            --text-muted: #64748b;
            --bg: #f8fafc;
            --card: #ffffff;
            --border: #e2e8f0;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        .high-contrast {
            --bg: #000000;
            --text: #fcd34d;
            --text-muted: #fbbf24;
            --card: #000000;
            --border: #fcd34d;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        .text-lg {
            font-size: 1.125rem;
            line-height: 1.75rem;
        }

        .font-mono {
            font-family: 'Courier New', monospace;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #475569;
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #059669;
        }

        .btn-warning {
            background-color: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background-color: #d97706;
        }

        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--border);
            color: var(--text);
        }

        .btn-outline:hover {
            background-color: var(--border);
        }

        .card {
            background-color: var(--card);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px var(--shadow);
        }

        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .justify-center {
            justify-content: center;
        }

        .gap-4 {
            gap: 1rem;
        }

        .gap-6 {
            gap: 1.5rem;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .mb-6 {
            margin-bottom: 1.5rem;
        }

        .mt-4 {
            margin-top: 1rem;
        }

        .p-4 {
            padding: 1rem;
        }

        .p-6 {
            padding: 1.5rem;
        }

        .text-center {
            text-align: center;
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .text-xl {
            font-size: 1.25rem;
        }

        .text-2xl {
            font-size: 1.5rem;
        }

        .text-3xl {
            font-size: 1.875rem;
        }

        .text-5xl {
            font-size: 3rem;
        }

        .font-bold {
            font-weight: 700;
        }

        .font-extrabold {
            font-weight: 800;
        }

        .grid {
            display: grid;
        }

        .grid-cols-3 {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }

        .grid-cols-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .hidden {
            display: none;
        }

        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .nav {
            position: sticky;
            top: 0;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            padding: 1rem 0;
            z-index: 100;
        }

        .exam-header {
            background-color: var(--card);
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border);
            box-shadow: 0 1px 3px var(--shadow);
            margin-bottom: 1rem;
        }

        .question-container {
            background-color: var(--card);
            padding: 1.5rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border);
            margin-bottom: 1rem;
        }

        .answer-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 0.5rem;
        }

        .answer-option:hover {
            border-color: #cbd5e1;
        }

        .answer-option.selected {
            border-color: var(--primary);
            background-color: #eff6ff;
        }

        .answer-option.correct {
            border-color: var(--success);
            background-color: #ecfdf5;
        }

        .answer-option.incorrect {
            border-color: var(--danger);
            background-color: #fef2f2;
        }

        .timer {
            font-family: monospace;
            font-weight: bold;
            font-size: 1.25rem;
        }

        .timer.warning {
            color: var(--danger);
            animation: pulse 1s infinite;
        }

        .chat-container {
            height: calc(100vh - 200px);
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .chat-input {
            display: flex;
            gap: 0.5rem;
        }

        .chat-input input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            font-size: 1rem;
        }

        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .settings-content {
            background-color: var(--card);
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-width: 24rem;
            width: 100%;
        }

        .toggle-switch {
            position: relative;
            width: 3rem;
            height: 1.5rem;
            background-color: var(--border);
            border-radius: 9999px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .toggle-switch.checked {
            background-color: var(--primary);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 0.25rem;
            left: 0.25rem;
            width: 1rem;
            height: 1rem;
            background-color: white;
            border-radius: 9999px;
            transition: transform 0.2s ease;
        }

        .toggle-switch.checked::after {
            transform: translateX(1.5rem);
        }

        .latex-content {
            line-height: 1.5;
        }

        .latex-content br {
            content: '';
            display: block;
            margin: 0.5rem 0;
        }

        .score-display {
            font-size: 6rem;
            font-weight: 800;
            line-height: 1;
        }

        .progress-bar {
            width: 100%;
            height: 0.5rem;
            background-color: var(--border);
            border-radius: 9999px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.3s ease;
        }

        .strength-tag {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .strength-tag.good {
            background-color: #ecfdf5;
            color: #065f46;
        }

        .strength-tag.weak {
            background-color: #fef2f2;
            color: #991b1b;
        }

        @media (max-width: 768px) {
            .grid-cols-3 {
                grid-template-columns: 1fr;
            }
            
            .grid-cols-2 {
                grid-template-columns: 1fr;
            }
            
            .exam-container {
                flex-direction: column;
            }
            
            .question-sidebar {
                width: 100%;
                order: 2;
            }
            
            .question-main {
                order: 1;
            }
        }
    </style>
</head>
<body>
    <nav class="nav">
        <div class="container flex justify-between items-center">
            <div class="flex items-center gap-2 font-bold text-xl cursor-pointer" id="nav-title">
                <svg class="lucide-icon" data-lucide="book-open"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5"></path><path d="M8 11h4"></path><path d="M8 15h4"></path><path d="M8 7h4"></path></svg>
                <span>NovaScholar</span>
            </div>
            <div class="flex gap-4">
                <button id="settings-btn" class="p-2 rounded-full hover:bg-slate-100 transition">
                    <svg class="lucide-icon" data-lucide="settings"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.28 1.44l-.52 1.2a2 2 0 0 0 .44 2.28l.15.08a2 2 0 0 1 1 1.73l.43.25a2 2 0 0 1 2 0l.15-.08a2 2 0 0 0 2.28-1.44l.52-1.2a2 2 0 0 0-.44-2.28l-.15.08a2 2 0 0 1-1-1.73l-.43-.25a2 2 0 0 1-2 0l-.15.08a2 2 0 0 0-1.72-2.28L4 9.83a2 2 0 0 0-1.44-.44l-.52 1.2a2 2 0 0 0 .44 2.28l.15.08a2 2 0 0 1 1 1.73l.43.25a2 2 0 0 1 2 0l.15-.08a2 2 0 0 0 2.28-1.44l.52-1.2a2 2 0 0 0-.44-2.28l-.15.08a2 2 0 0 1-1-1.73l-.43-.25a2 2 0 0 1-2 0l-.15.08a2 2 0 0 0-1.72-2.28L4 9.83"></path></svg>
                </button>
            </div>
        </div>
    </nav>

    <main class="container" id="main-content">
        <!-- Home View -->
        <div id="home-view" class="text-center space-y-12 mt-10">
            <div class="space-y-6">
                <div class="inline-block p-3 bg-blue-100 rounded-full text-blue-600 mb-4">
                    <svg class="lucide-icon" data-lucide="brain" style="width: 48px; height: 48px;"></svg>
                </div>
                <h1 class="text-5xl font-extrabold tracking-tight">
                    Nova<span class="text-blue-600">Scholar</span>
                </h1>
                <p class="text-xl text-slate-600 max-w-2xl mx-auto">
                    Your AI companion for AP mastery. Adaptive tutoring, realistic simulations, and instant feedback.
                </p>
                
                <div class="flex flex-wrap justify-center gap-4 pt-4">
                    <button id="start-chat-btn" class="btn btn-secondary">
                        <svg class="lucide-icon" data-lucide="message-square"></svg>
                        Start Chatting
                    </button>
                    <button id="take-exam-btn" class="btn btn-primary">
                        <svg class="lucide-icon" data-lucide="check-circle"></svg>
                        Take Mock Exam
                    </button>
                    <button id="exam-history-btn" class="btn btn-outline" disabled>
                        <svg class="lucide-icon" data-lucide="bar-chart-2"></svg>
                        Review Past Exams (0)
                    </button>
                </div>
            </div>

            <div class="grid gap-6">
                <div class="grid-cols-3">
                    <div class="card p-6 rounded-2xl shadow-sm">
                        <div class="mb-4"><svg class="lucide-icon text-amber-500" data-lucide="award"></svg></div>
                        <h3 class="font-bold text-lg mb-2">Score Prediction</h3>
                        <p class="text-slate-600">Get a projected AP score (1-5) based on your performance.</p>
                    </div>
                    <div class="card p-6 rounded-2xl shadow-sm">
                        <div class="mb-4"><svg class="lucide-icon text-purple-500" data-lucide="zap"></svg></div>
                        <h3 class="font-bold text-lg mb-2">Practice Mode</h3>
                        <p class="text-slate-600">Immediate feedback on every question to learn as you go.</p>
                    </div>
                    <div class="card p-6 rounded-2xl shadow-sm">
                        <div class="mb-4"><svg class="lucide-icon text-emerald-500" data-lucide="eye"></svg></div>
                        <h3 class="font-bold text-lg mb-2">Inclusive Design</h3>
                        <p class="text-slate-600">Dyslexia-friendly fonts, high contrast, and extended time options.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat View -->
        <div id="chat-view" class="hidden chat-container">
            <div class="flex justify-between items-center mb-4">
                <button id="chat-back-btn" class="p-2 hover:bg-slate-100 rounded-lg">
                    <svg class="lucide-icon" data-lucide="arrow-left"></svg>
                </button>
                <h2 class="font-bold text-xl">AI Study Partner</h2>
                <div class="w-10"></div>
            </div>

            <div class="chat-messages mb-4">
                <div class="mb-4">
                    <div class="bg-slate-100 rounded-2xl p-4 rounded-bl-none">
                        Hi! I'm Nova. What subject are we crushing today?
                    </div>
                </div>
            </div>

            <div class="chat-input">
                <input type="text" id="chat-input" placeholder="Ask about Calculus, History, or paste a problem..." class="flex-1 p-3 border-2 border-slate-200 rounded-lg focus:border-blue-500">
                <button id="chat-send-btn" class="btn btn-primary">
                    <svg class="lucide-icon" data-lucide="chevron-right"></svg>
                </button>
            </div>
        </div>

        <!-- Exam Setup View -->
        <div id="exam-setup-view" class="hidden">
            <button id="setup-back-btn" class="mb-6 flex items-center text-slate-500 hover:text-slate-800">
                <svg class="lucide-icon" data-lucide="arrow-left"></svg> Back to Home
            </button>
            
            <h2 class="text-3xl font-bold mb-6">Select Subject</h2>
            <div class="grid gap-3" id="subject-list">
                <!-- Subjects will be populated by JavaScript -->
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settings-modal" class="hidden settings-modal">
            <div class="settings-content">
                <div class="p-6 border-b flex justify-between items-center">
                    <h3 class="text-xl font-bold flex items-center gap-2">
                        <svg class="lucide-icon" data-lucide="settings"></svg> Accommodations
                    </h3>
                    <button id="close-settings-btn">
                        <svg class="lucide-icon" data-lucide="x"></svg>
                    </button>
                </div>
                <div class="p-6 space-y-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <svg class="lucide-icon" data-lucide="type"></svg>
                            <span>Larger Text</span>
                        </div>
                        <div id="large-text-toggle" class="toggle-switch"></div>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <svg class="lucide-icon" data-lucide="sun"></svg>
                            <span>High Contrast Mode</span>
                        </div>
                        <div id="high-contrast-toggle" class="toggle-switch"></div>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <svg class="lucide-icon" data-lucide="clock"></svg>
                            <span>Extended Time (50%)</span>
                        </div>
                        <div id="extended-time-toggle" class="toggle-switch"></div>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <svg class="lucide-icon" data-lucide="eye"></svg>
                            <span>Dyslexia Friendly Font</span>
                        </div>
                        <div id="dyslexia-font-toggle" class="toggle-switch"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // State management
        let state = {
            view: 'home',
            selectedSubject: '',
            messages: [{ role: 'model', text: "Hi! I'm Nova. What subject are we crushing today?" }],
            inputMessage: '',
            examConfig: {
                mode: 'timed',
                length: 'diagnostic'
            },
            examData: null,
            currentQuestionIndex: 0,
            answers: {},
            revealedAnswers: {},
            grading: null,
            timeLeft: 0,
            completedExams: [],
            accommodations: {
                largeText: false,
                highContrast: false,
                extendedTime: false,
                dyslexiaFont: false
            }
        };

        // Constants
        const AP_SUBJECTS = [
            "AP Art History", "AP Biology", "AP Calculus AB", "AP Calculus BC", 
            "AP Chemistry", "AP Chinese", "AP Computer Science A", "AP Computer Science Principles",
            "AP English Language", "AP English Literature", "AP Environmental Science", 
            "AP European History", "AP French", "AP German", "AP Gov & Politics: US", 
            "AP Gov & Politics: Comparative", "AP Human Geography", "AP Italian", 
            "AP Japanese", "AP Latin", "AP Macroeconomics", "AP Microeconomics", 
            "AP Music Theory", "AP Physics 1", "AP Physics 2", "AP Physics C: Mech", 
            "AP Physics C: E&M", "AP Psychology", "AP Research", "AP Seminar", 
            "AP Spanish Lang", "AP Spanish Lit", "AP Statistics", "AP Studio Art: 2D", 
            "AP Studio Art: 3D", "AP Studio Art: Drawing", "AP US History", "AP World History"
        ];

        const SUBJECT_CONFIG = {
            "AP Calculus AB": {
                desc: "Focuses on limits, derivatives, and integrals.",
                full: { mcq: 45, frq: 6, time: 195 },
                diagnostic: { mcq: 10, frq: 2, time: 45 }
            },
            "AP Calculus BC": {
                desc: "Covers AB topics plus sequences, series, and parametric equations.",
                full: { mcq: 45, frq: 6, time: 195 },
                diagnostic: { mcq: 10, frq: 2, time: 45 }
            },
            "AP Biology": {
                desc: "Study the core scientific principles of living organisms.",
                full: { mcq: 60, frq: 6, time: 90 }, 
                diagnostic: { mcq: 15, frq: 2, time: 30 }
            },
            "DEFAULT": {
                desc: "Standardized AP curriculum practice.",
                full: { mcq: 50, frq: 4, time: 180 },
                diagnostic: { mcq: 10, frq: 1, time: 30 }
            }
        };

        const SYSTEM_PROMPT_TUTOR = `You are Nova, an expert AP tutor and study companion. 
- Explain concepts clearly and concisely.
- Use LaTeX formatting for ALL math equations, enclosing them in $...$ for inline and $$...$$ for block equations.
- Example: "The quadratic formula is $$x = {-b \\pm \\sqrt{b^2-4ac} \\over 2a}$$".
- Be encouraging and supportive.`;

        const SYSTEM_PROMPT_GRADER = `You are an expert AP Exam grader. 
- Analyze the student's answers against the correct answers and rubrics.
- Return valid JSON only.
- JSON Structure: 
{ 
  "ap_score": 3, 
  "score_range": "3-4", 
  "raw_score": "15/20", 
  "feedback": "General feedback paragraph...", 
  "strengths": ["Topic A", "Topic B"], 
  "weaknesses": ["Topic C", "Topic D"], 
  "detailed_analysis": [ 
    { "question_id": 1, "status": "Correct", "note": "Explanation of why the answer is right/wrong..." } 
  ] 
}
- "ap_score" should be an integer 1-5 based on the difficulty and performance.`;

        // DOM Elements
        const elements = {
            homeView: document.getElementById('home-view'),
            chatView: document.getElementById('chat-view'),
            examSetupView: document.getElementById('exam-setup-view'),
            mainContent: document.getElementById('main-content'),
            navTitle: document.getElementById('nav-title'),
            settingsBtn: document.getElementById('settings-btn'),
            closeSettingsBtn: document.getElementById('close-settings-btn'),
            settingsModal: document.getElementById('settings-modal'),
            chatBackBtn: document.getElementById('chat-back-btn'),
            chatInput: document.getElementById('chat-input'),
            chatSendBtn: document.getElementById('chat-send-btn'),
            chatMessages: document.querySelector('.chat-messages'),
            setupBackBtn: document.getElementById('setup-back-btn'),
            subjectList: document.getElementById('subject-list'),
            startChatBtn: document.getElementById('start-chat-btn'),
            takeExamBtn: document.getElementById('take-exam-btn'),
            examHistoryBtn: document.getElementById('exam-history-btn'),
            largeTextToggle: document.getElementById('large-text-toggle'),
            highContrastToggle: document.getElementById('high-contrast-toggle'),
            extendedTimeToggle: document.getElementById('extended-time-toggle'),
            dyslexiaFontToggle: document.getElementById('dyslexia-font-toggle')
        };

        // Utility Functions
        function renderLatex(text) {
            if (!text) return '';
            const formattedText = text.replace(/\n/g, '<br />');
            return formattedText;
        }

        function updateMathJax(element) {
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetClear([element]);
                window.MathJax.typesetPromise([element]).catch(err => console.error('MathJax error:', err));
            }
        }

        async function callGemini(prompt, systemPrompt) {
            const apiKey = "AIzaSyB9xg-rKXIrKFJSrj9Yxr4B-8_8-y_vyPE";
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-preview-09-2025:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    }
                );

                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "No response generated.";
            } catch (error) {
                console.error("Gemini API call failed:", error);
                throw error;
            }
        }

        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            if (hours > 0) {
                return `${hours}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function updateThemeClasses() {
            document.body.className = '';
            if (state.accommodations.highContrast) {
                document.body.classList.add('high-contrast');
            }
            if (state.accommodations.largeText) {
                document.body.classList.add('text-lg');
            }
            if (state.accommodations.dyslexiaFont) {
                document.body.classList.add('font-mono');
            }
        }

        // View Management
        function showView(viewName) {
            state.view = viewName;
            
            // Hide all views
            elements.homeView.classList.add('hidden');
            elements.chatView.classList.add('hidden');
            elements.examSetupView.classList.add('hidden');
            
            // Show selected view
            if (viewName === 'home') {
                elements.homeView.classList.remove('hidden');
            } else if (viewName === 'chat') {
                elements.chatView.classList.remove('hidden');
            } else if (viewName === 'exam_setup') {
                elements.examSetupView.classList.remove('hidden');
                renderSubjectList();
            }
            
            updateHistoryButton();
        }

        function renderSubjectList() {
            elements.subjectList.innerHTML = '';
            AP_SUBJECTS.forEach(subject => {
                const button = document.createElement('button');
                button.className = 'text-left p-4 rounded-xl border border-slate-200 hover:border-blue-500 hover:bg-blue-50 transition flex items-center justify-between group bg-white';
                button.innerHTML = `
                    <span class="font-medium">${subject}</span>
                    <svg class="lucide-icon text-slate-300 group-hover:text-blue-500" data-lucide="chevron-right"></svg>
                `;
                button.addEventListener('click', () => configureExam(subject));
                elements.subjectList.appendChild(button);
            });
            lucide.createIcons();
        }

        function updateHistoryButton() {
            if (state.completedExams.length > 0) {
                elements.examHistoryBtn.disabled = false;
                elements.examHistoryBtn.innerHTML = `
                    <svg class="lucide-icon" data-lucide="bar-chart-2"></svg>
                    Review Past Exams (${state.completedExams.length})
                `;
            } else {
                elements.examHistoryBtn.disabled = true;
                elements.examHistoryBtn.innerHTML = `
                    <svg class="lucide-icon" data-lucide="bar-chart-2"></svg>
                    Review Past Exams (0)
                `;
            }
        }

        // Event Handlers
        function configureExam(subject) {
            state.selectedSubject = subject;
            showView('exam_config');
        }

        function handleSendMessage() {
            const message = state.inputMessage.trim();
            if (!message) return;
            
            // Add user message
            state.messages.push({ role: 'user', text: message });
            state.inputMessage = '';
            renderChatMessages();
            
            // Show loading
            state.messages.push({ role: 'model', text: 'Thinking...' });
            renderChatMessages();
            
            // Call AI
            callGemini(message, SYSTEM_PROMPT_TUTOR)
                .then(response => {
                    // Remove loading message and add response
                    state.messages.pop();
                    state.messages.push({ role: 'model', text: response });
                    renderChatMessages();
                })
                .catch(err => {
                    state.messages.pop();
                    state.messages.push({ role: 'model', text: "Sorry, I encountered an error connecting to my brain. Please try again." });
                    renderChatMessages();
                });
        }

        function renderChatMessages() {
            elements.chatMessages.innerHTML = '';
            state.messages.forEach((message, idx) => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `mb-4 ${message.role === 'user' ? 'flex justify-end' : 'flex justify-start'}`;
                
                const bubble = document.createElement('div');
                bubble.className = message.role === 'user' 
                    ? 'bg-blue-600 text-white rounded-2xl p-4 rounded-br-none max-w-[85%]'
                    : 'bg-slate-100 text-slate-800 rounded-2xl p-4 rounded-bl-none max-w-[85%] border border-slate-200';
                
                const content = document.createElement('div');
                content.className = 'latex-content';
                content.innerHTML = renderLatex(message.text);
                updateMathJax(content);
                
                bubble.appendChild(content);
                messageDiv.appendChild(bubble);
                elements.chatMessages.appendChild(messageDiv);
            });
        }

        // Initialize app
        function init() {
            // Load saved state
            const savedState = localStorage.getItem('novaScholarState');
            if (savedState) {
                try {
                    const parsed = JSON.parse(savedState);
                    state = { ...state, ...parsed };
                } catch (e) {
                    console.error("Failed to load saved state", e);
                }
            }

            // Set up event listeners
            elements.navTitle.addEventListener('click', () => showView('home'));
            elements.settingsBtn.addEventListener('click', () => {
                elements.settingsModal.classList.remove('hidden');
            });
            elements.closeSettingsBtn.addEventListener('click', () => {
                elements.settingsModal.classList.add('hidden');
            });
            elements.chatBackBtn.addEventListener('click', () => showView('home'));
            elements.chatSendBtn.addEventListener('click', handleSendMessage);
            elements.chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') handleSendMessage();
            });
            elements.setupBackBtn.addEventListener('click', () => showView('home'));
            elements.startChatBtn.addEventListener('click', () => showView('chat'));
            elements.takeExamBtn.addEventListener('click', () => showView('exam_setup'));

            // Settings toggles
            elements.largeTextToggle.addEventListener('click', () => {
                elements.largeTextToggle.classList.toggle('checked');
                state.accommodations.largeText = !state.accommodations.largeText;
                updateThemeClasses();
            });

            elements.highContrastToggle.addEventListener('click', () => {
                elements.highContrastToggle.classList.toggle('checked');
                state.accommodations.highContrast = !state.accommodations.highContrast;
                updateThemeClasses();
            });

            elements.extendedTimeToggle.addEventListener('click', () => {
                elements.extendedTimeToggle.classList.toggle('checked');
                state.accommodations.extendedTime = !state.accommodations.extendedTime;
            });

            elements.dyslexiaFontToggle.addEventListener('click', () => {
                elements.dyslexiaFontToggle.classList.toggle('checked');
                state.accommodations.dyslexiaFont = !state.accommodations.dyslexiaFont;
                updateThemeClasses();
            });

            // Close modal when clicking outside
            elements.settingsModal.addEventListener('click', (e) => {
                if (e.target === elements.settingsModal) {
                    elements.settingsModal.classList.add('hidden');
                }
            });

            // Initial render
            showView(state.view);
            updateThemeClasses();
            lucide.createIcons();
        }

        // Start the app
        init();
    </script>
</body>
</html>